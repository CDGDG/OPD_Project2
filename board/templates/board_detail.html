{% extends "base.html" %}
{% block title %}게시판{% endblock %}
{% block content %}
<div class="row mt-5">
    <div class="col-12 mt-4">
        <div class="form-group detailDiv rounded row p-4" id="form_id">
                <tr onclick="location.href='/board/detail/{{board.pk}}/'">
                    <h1>제목 : {{board.title}} </h1>
                    <p>조회수 : {{ board.viewcnt}}</p>
                    <hr>
                    <p>작성일 : {{ board.regdate }}</p>
                </tr>     
                <label>내용</label>
                <textarea style="height:300px; resize: none;" class="form-control" id="contents" readonly>{{board.contents}}</textarea>

                <label>첨부 파일</label>
                {% if boardimg == '' %}
                <p>첨부파일이 없습니다</p>
                {% else %}
                <a class='form-control' href="{% url 'Board:filedownload' boardimg.pk %}">{{ boardimg.img_original }}</a>
                {% endif %}
                
            </label>
            <br>
            <div class="comment-area">
                <!-- Comments Form -->
                <form action="{% url 'Board:commentwrite' board.pk %}" name="commentForm" id="commentwrite" method="POST">
                    {% csrf_token %}
                    <div class="card my-4">
                        <h5 class="card-header">댓글 달기:</h5>
                        <label><input type="checkbox" name="private" id="private">비공개</label>
                        <div class="card-body">
                            <div class="form-group">
                                <textarea class="form-control" name="contents" rows="3"></textarea>
                            </div>
                            {% if request.session.who == 'developer' %}
                            <button type="button" id="commentwrite_button" class="btn btn-primary">작성</button>
                            {% endif %}
                        </div>
                    </div>
                </form>
                
                <p><b>댓글 목록</b></p>
                <!-- <p>아직 댓글이 없습니다.</p> -->
                {% for comment in comments %}
                <div class="media mb-4" id="comment-{{ comment.pk }}">
                    <div class="media-body">
                        <h5 class="mt-0">&nbsp;<small class="text-muted">{{ comment.regdate }}</small>
                        </h5>
                    </div>
                </div>
                {% if comment.developer.id == request.session.id and request.session.who == 'developer' %}
                    <b style="display: inline-block;">{{comment.developer.nickname}} :</b>
                    <span style="display: inline-block;">{{ comment.contents | linebreaks }}</span>
                
                    <button class="btn btn-primary" id="commentdelete{{ comment.pk }}">삭제</button>
                <hr>
                    <script>
                        $(document).ready(function(){
                            $('#commentdelete{{ comment.pk }}').click(function(){
                                $.ajax({
                                    url: "{% url 'Board:commentdelete' %}",
                                    type : "POST",
                                    data : {'csrfmiddlewaretoken': $('#csrf_token').val(), 'pk':'{{comment.pk}}'},
                                    dataType: 'json',
                                    success:function(response){
                                        alert('삭제성공~')
                                        location.reload();
                                    }
                                })
                            })
                        })
                    </script>
                {% elif comment.company.id == request.session.id and request.session.who == 'company' %}
                    <b style="display: inline-block;">{{comment.company.name}} :</b>
                    <span style="display: inline-block;">{{ comment.contents | linebreaks }}</span>
                
                    <button class="btn btn-primary" id="commentdelete{{ comment.pk }}">삭제</button>
                <hr>   
                    <script>
                        $(document).ready(function(){
                            $('#commentdelete{{ comment.pk }}').click(function(){
                                $.ajax({
                                    url: "{% url 'Board:commentdelete' %}",
                                    type : "POST",
                                    data : {'csrfmiddlewaretoken': $('#csrf_token').val(), 'pk':'{{comment.pk}}'},
                                    dataType: 'json',
                                    success:function(response){
                                        alert('삭제성공~')
                                        location.reload();
                                    }
                                })
                            })
                        })
                    </script>
                {% elif board.developer.id == request.session.id and request.session.who == 'developer' %} 
                    {% if comment.developer %}
                        <b style="display: inline-block;">{{comment.developer.nickname}} :</b>
                        <span style="display: inline-block;">{{ comment.contents | linebreaks }}</span>
                        <hr>
                        {% elif comment.company %}
                        <b style="display: inline-block;">{{comment.company.name}} :</b>
                        <span style="display: inline-block;">{{ comment.contents | linebreaks }}</span>
                        <hr>
                    {% endif %}
                {% else %}
                    {% if comment.private %}
                        <p>비밀 댓글입니다</p>
                    {% else %}
                        <b style="display: inline-block;">{{comment.developer.nickname}} :</b>
                        <span style="display: inline-block;">{{ comment.contents | linebreaks }}</span>
                    {% endif %}
                <hr>
                {% endif %}
                {% empty %}
                    <p id="contents" style="color: darkgray;" readonly>아직 댓글이 없습니다...</p>
                <hr>



                {% endfor %}
                
            </div>
           
        <div class="mt-3">

            <a class="btn btn-outline-dark" href='{% url "Board:list" %}'>목록</a>
            {% if request.session.who == 'developer' and request.session.id == board.developer.pk %}
            <a class="btn btn-outline-dark" href='{% url "Board:update" board.pk %}'>수정하기</a>
            <a class="btn btn-outline-dark" onclick="chkDelete()">삭제하기</a>
            {% endif %}
            <form action="{% url 'Board:delete' %}" name="delete" method="POST">
                {% csrf_token %}
                <input type="hidden" name="pk" value="{{board.pk}}">
            </form>
            <script>
                function chkDelete(){
                    //삭제 여부
                    var r = confirm("삭제하시겠습니까?")
                    if(r){
                        document.forms.delete.submit();
                    }
                }
            </script>

        </div>
    </div>
</div>
<input type="hidden" value="{{csrf_token}}" id="csrf_token">
{% endblock %}

{% block script %}
<script>
    $(document).ready(function(){
        $('#commentwrite_button').click(function(){
            if ($('[name=contents]').val() == '') {
                $('[name=contents]').focus()
                alert('댓글을 입력해주세요')
            }else{
                document.forms['commentForm'].submit()
            }

        })
    })
</script>
{% endblock %}