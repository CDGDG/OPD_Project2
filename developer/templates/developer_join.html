{% extends 'base.html' %}
{% block content %}
<div class="row mt-5">
    <div class="col-12">
        <form method="POST" action="{% url 'Developer:join' %}" enctype="multipart/form-data" name="joinfrm">
            {% csrf_token %}
            {% for field in form %}
            <div class="form-group">
                {% if field.name == 'language' %}
                <label>{{field.label}}</label>
                <ul class='form-control' style='list-style-type: none;'>
                    {% for f in field %}
                    <li>{{f}}</li>
                    {% endfor %}
                </ul>
                {% elif field.name == 'email_option'%}
                    @<input type="{{field.field.widget.input_type}}" id="email_option" name="{{field.name}}" class="form-control">
                    <select id="email_select">
                        <option value="">직접입력</option>
                        <option value="naver.com">naver.com</option>
                        <option value="gmail.com">gmail.com</option>
                        <option value="daum.net">daum.net</option>
                    </select>
                    <input type="button" value="이메일 인증" id="send_email">
                    <div id="check_{{field.name}}"></div>
                    <input type="text" placeholder="인증번호를 입력해 주세요" id="emailnum" name="emailnum" class="form-control" style="display:none">
                    <input type="button" value="인증하기" id="check_emailnum" name="check_emailnum" style="display:none">
                    <div id="check_email_result"></div>
                {% else %}
                <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                <input type="{{ field.field.widget.input_type }}" class="form-control" id="{{ field.id_for_label }}"
                    placeholder="{{ field.label }}" name="{{ field.name }}" />
                    <div id="check_{{field.name}}"></div>
                    {% if field.name == "userid"%}
                    <input type="button" id="duple_userid" value="중복검사"><div id="dupleId_result"></div>
                    {% endif %}
                    {% if field.name == "nickname"%}
                    <input type="button" id="duple_nickname" value="중복검사"><div id="dupleNick_result"></div>
                    {% endif %}
                {% endif %}
                {% if field.errors %}
                <span class="text-danger">{{ field.errors }}</span>
                {% endif %}
                {% endfor %}
                <div class="mt-3">
                <input type="button" class="btn btn-primary mt-3" id="join" value="회원가입">
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock content %}

{% block script %}
<script>
$(document).ready(function(){
    var id_button = false;
    var nick_button = false;
    $('#duple_userid').click(function(){
        var userid=$('#id_userid').val()
        $.ajax({
            url: "{% url 'Developer:check_id' %}",
            data: {'userid': userid},
            datatype:'json',
    
            success : function(response){
                if(response.blank){
                    $('#dupleId_result').html('<p>아이디를 입력해주세요</p>')
                    id_button = false
                }else{
                    if(response.data == 'not exist'){
                        $('#dupleId_result').html('<p style="color:green">사용가능한 아이디입니다</p>')
                        id_button = true
                        return;
                    }else{
                        $('#dupleId_result').html('<p style="color:red">중복된 아이디입니다</p>')
                        id_button = false
                        return;
                        
                    }

                }
                
            }
            
        })
    })
    $('#duple_nickname').click(function(){
        var nickname=$('#id_nickname').val()
        $.ajax({
            url:"{% url 'Developer:check_nick' %}",
            data:{'nickname':nickname},
            datatype:'json',

            success : function(response){
                if(response.blank){
                    $('#dupleNick_result').html('<p>닉네임을 입력해주세요</p>')
                    nick_button = false
                }else{
                    if(response.data == 'not exist'){
                        $('#dupleNick_result').html('<p style="color:green">사용가능한 닉네임입니다</p>')
                        nick_button=true;
                        return;
                    }else{
                        $('#dupleNick_result').html('<p style="color:red">중복된 닉네임입니다</p>')
                        nick_button=false;
                        return;
                        
                    }

                }
                
            }
        })
    })

    $('#send_email').click(function(){
        var joinfrm = document.forms['joinfrm']
        var email_id = joinfrm['email_id'].value.trim()
        var email_option = joinfrm['email_option'].value.trim()
        var num_list = []
        for(var i=0;i<4;i++){
            num_list.push(Math.floor(Math.random() * 10)+"")
        }
        var emailnum = num_list.join("")
        $.ajax({
            url:"{% url 'Developer:send_email' %}",
            data : {'email_id':email_id,'email_option':email_option,'emailnum':emailnum},
            datatype:'json',
            success:function(response){
                if(response.fail){
                    $('#check_email_option').html('<p style="color:red">이메일 인증에 실패 했습니다 다시 시도해주세요</p>')
                }
                if(response.blank){
                    $('#check_email_option').html('<p style="color:red">이메일을 입력해주세요</p>')
                }else{
                    $('#check_email_option').html('<p style="color:green">인증번호를 입력해주세요</p>')
                    $('#emailnum').css('display','block')
                    $('#check_emailnum').css('display','block')
                    $('#check_emailnum').click(function(){
                        if(joinfrm['emailnum'].value.trim() == ""){
                            $('#check_email_result').html('<p style="color:red">인증번호를 입력해주세요</p>')
                        }else if(joinfrm['emailnum'].value.trim() != emailnum){
                            $('#check_email_result').html('<p style="color:red">인증번호를 확인해주세요</p>')
                        }else{
                            $('#check_email_result').html('<p style="color:green">인증되었습니다</p>')
                            
                        }
                    })
                }
            }
        })
    })
    $('#id_userid').change(function(){
        id_button = false
    })
    $('#id_nickname').change(function(){
        nick_button = false
    })
    $('#email_select').change(function(){
        $("#email_option").val($('#email_select').val());
    })
    $('#join').click(function(){
        var joinfrm = document.forms['joinfrm']
		var reg_pass = /^(?=.*[A-Za-z])(?=.*\d)(?=.*[@$!%*#?&])[A-Za-z\d@$!%*#?&]{8,}$/;
		var reg_id = /^[a-z]+[a-z0-9]{5,19}$/g; 
        
        if(joinfrm['userid'].value.trim()==""){
            joinfrm['userid'].focus();
            $('#check_userid').html('<p style="color:red">아이디를 입력해주세요</p>')
            return false;
        }

        if(!reg_id.test(joinfrm['userid'].value.trim())){
        }
        
        if(!reg_pass.test(joinfrm['password'].value.trim())){
            joinfrm['password'].focus();
            $('#check_password').html('<p style="color:red">유효한 비밀번호가 아닙니다</p>')
            return false;
        }
        
        if(!id_button){
            joinfrm['userid'].focus();
            $('#check_userid').html('<p style="color:red">아이디 중복검사를 해주세요</p>')
            return false;
        }
        if(!nick_button){
            joinfrm['nick_button'].focus();
            $('#check_nickname').html('<p style="color:red">닉네임 중복검사를 해주세요</p>')
            return false;
            
        }
        if(!send_email){
            joinfrm['send_email'].focus();
            $('#check_email_option').html('<p style="color:red">이메일 인증을 해주세요</p>')
            return false;
        }
       
        joinfrm.submit();
    }) 

})

document.addEventListener('keydown', function(event) {
    if (event.keyCode === 13) {
    event.preventDefault();
    };
}, true);
</script>
{% endblock script %}
